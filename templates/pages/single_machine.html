{% extends 'layouts/main.html' %}
{% block title %}Machines{% endblock %}


{% block content %}
<style>

#plot1 {
    min-height: 600px;
    height: 100%;
}

.row1 {
   height: 100%;
}

.date-select-container {
    float: left;
    width: 200px;
    padding-left: 10px;
}

</style>

<div class="row row1">
    <div class="col-md-5" id="col-status">
    
  
      <div class="row row1">
    	<div class="col-md-7" id="col-status">
       
        <div class="panel panel-default">
            <div class="panel-heading"><strong>Machine Id {{machine_id}}</strong></div>
            <div class="panel-body">
                <div id="machine-table">
                    <table class="table">
                        <thead>
                        	<tr>
                            	<th scope="col">Model</th>
                            	<th scope="col">Age</th>
                            	<th scope="col">Last Maintenance</th>
                            	<th scope="col">Status</th>
                        	</tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        </div>
        <div class="col-md-5" id="col-status">
         	<div class="panel panel-default">
            	<div class="panel-heading"><strong>Risk Gauge</strong></div>
            	<div class="panel-body">
            		<div id="myDiv">
            			<table class="table">
                        	<thead>
                        		<tr>
                            		<th scope="col">Risk Score</th>
                            		<th scope="col">Predicted Failure Time</th>
                            		<th scope="col">Meaning</th>
                        		</tr>
                        	</thead>
                        	<tbody></tbody>
                    	</table>
            		</div>
            	</div>
            </div>
        </div> 
    </div> 
        
        
        <div class="panel panel-default">
            <div class="panel-heading"><strong>Address</strong></div>
            <div class="panel-body">
                	<div id="machine-geo" style="height:200px"></div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading"><strong>Last failures</strong></div>
            <div class="panel-body">
                <div id="failures-table">
                    <table class="table table-striped table-dark">
                        <thead>
                        	<tr>
                            	<th scope="col">Timestamp</th>
                            	<th scope="col">Component</th>
                        	</tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
         
    
    </div>
    <div class="col-md-7" style="height:100%">
    	<div class="panel panel-default" style="height:100%">
            <div class="panel-heading"><strong>Telemetry</strong></div>
            <div class="panel-body">
        		<div class="row" style="height:100%">
            		<div class="date-select-container">
                		<label for="plot-start-date">From</label>
                		<div class="input-group date" data-provide="datepicker">
                    		<input type="text" class="form-control date-select" id="plot-start-date" value="01/11/2015">
                    		<div class="input-group-addon">
                        		<span class="glyphicon glyphicon-th"></span>
                    		</div>
                		</div>
            		</div>
            		<div class="date-select-container">
                		<label for="plot-end-date">To</label>
                		<div class="input-group date" data-provide="datepicker">
                    		<input type="text" class="form-control date-select" id="plot-end-date" value="01/12/2015">
                    		<div class="input-group-addon">
                        		<span class="glyphicon glyphicon-th"></span>
                    		</div>
                		</div>
            		</div>
        		</div>
        		<div class="row">
            		<div id="plot1" style="height:100%"></div>
        		</div>
            </div>
         </div>
    </div>
</div>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyC4o8qkCrbHngwyPSIizV2RGHmyvDmgmXM"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="/static/js/plotly-latest.min.js"></script>

<script type="text/javascript">
google.load("visualization", "1", {packages:["corechart", "table", "geochart", "map"]});

$.fn.datepicker.defaults.format = "dd/mm/yyyy";
$.fn.datepicker.defaults.autoclose = true;

Utils.request('{{url_for('machine_status', machine_id=machine_id)}}', {
    selector: '#col-status',
    success: function(data, widget) {
        widget.find('#machine-table').prepend('<img src="{0}" alt="{1}">'.format(Utils.machineIcon(data.model, 64), data.model));

        widget.find('#machine-table tbody').html(`<tr></th><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>`
            .format(data.model, data.age, data.last_maint,  data.status)
        );

		//////////////////////////////////////////////////////
		//fake risk score calculation and gauge representation
		var value = Math.floor(Math.random() * 100);
		
		if (value < 15) {
			widget.find('#myDiv').prepend('<center><img src="/static/img/gauges/gaugevlow.gif"></center>');
			widget.find('#myDiv tbody').html('<tr></th><td>{0}%</td><td>months</td><td>Very Low Risk</td></tr>'.format(value));
		}
		else if (value < 30) {
			widget.find('#myDiv').prepend('<center><img src="/static/img/gauges/gaugelow.gif"></center>');
			widget.find('#myDiv tbody').html('<tr></th><td>{0}%</td><td>1 month</td><td>Low Risk</td></tr>'.format(value));
		}
		else if (value < 45) {
			widget.find('#myDiv').prepend('<center><img src="/static/img/gauges/gaugemlow.gif"></center>');
			widget.find('#myDiv tbody').html('<tr></th><td>{0}%</td><td>weeks</td><td>Medium-Low Risk</td></tr>'.format(value));
		}
		else if (value < 60) {
			widget.find('#myDiv').prepend('<center><img src="/static/img/gauges/gaugemedium.gif"></center>');
			widget.find('#myDiv tbody').html('<tr></th><td>{0}%</td><td>2-3 weeks</td><td>Medium Risk</td></tr>'.format(value));
		}
		else if (value < 75) {
			widget.find('#myDiv').prepend('<center><img src="/static/img/gauges/gaugemhigh.gif"></center>');
			widget.find('#myDiv tbody').html('<tr></th><td>{0}%</td><td>less than 1 week</td><td>Medium-High Risk</td></tr>'.format(value));
		}
		else if (value < 90) {
			widget.find('#myDiv').prepend('<center><img src="/static/img/gauges/gaugehigh.gif"></center>');
			widget.find('#myDiv tbody').html('<tr></th><td>{0}%</td><td>2-3 days</td><td>High Risk</td></tr>'.format(value));
		}
		else {
			widget.find('#myDiv').prepend('<center><img src="/static/img/gauges/gaugevhigh.gif"></center>');
			widget.find('#myDiv tbody').html('<tr></th><td>{0}%	</td><td>anytime</td><td>Very High Risk</td></tr>'.format(value));
		}
		//////////////////////////////////////////////////////

        var rows = data.last_failures.map(x => '<tr></th><td>{0}</td><td>{1}</td></tr>'.format(x.datetime, x.failure))
        widget.find('#failures-table tbody').html(rows.join('\n'));
        
         // Drawing geo plot
        var geoData = [["lat", "long", "icon"]];
        console.log(data.lat);
        geoData.push([data.lat, data.long, data.model]);

        var t = google.visualization.arrayToDataTable(geoData);
        console.log(t);
        var chart = new google.visualization.Map($('#machine-geo').get(0));
        
        var models = ["model1", "model2", "model3", "model4"];
        icons = {}

        for(var i = 0; i < models.length; i ++) {
            icons[models[i]] = {
                normal: Utils.machineIcon(models[i], 48),
                selected: Utils.machineIcon(models[i], 48),
            }
        }

        options = {
            mapType: 'normal',
            showTip: true,
            zoomLevel: 15,
            icons: icons
        }

        chart.draw(t, options);
        
    }
});


$('.date-select').change( function() {
    console.log('changed', this);
    drawTelemetry()
})

$('.date-select').change( function() {
    console.log('changed', this);
    drawTelemetry()
})

drawTelemetry()

function drawTelemetry() {
    var start = $('#plot-start-date').val()
    var end = $('#plot-end-date').val()

    Utils.request('{{url_for('machine_telemetry', machine_id=machine_id)}}', {
        selector: '#plot1',
        data: {start: start, end: end},
        success: function(data, widget) {
            console.log(data)
            var labels = ['volt', 'pressure', 'rotate', 'vibration'];
            var traces = labels.map( function(l) {
            	switch(l) {
            		case 'volt':
                	return {
                    	//x: data.telemetry.map(x =>  Date.parse(x.datetime)),
                   		x: data.telemetry.map(x =>  x.datetime),
                    	y: data.telemetry.map(x => x[l]),
                    	name: l,
                    	visible: 'legendonly',
                    	type: 'scatter',
                    	line: {shape: 'spline'}
                	}
                	case 'pressure':
                	return {
                    	//x: data.telemetry.map(x =>  Date.parse(x.datetime)),
                   		x: data.telemetry.map(x =>  x.datetime),
                    	y: data.telemetry.map(x => x[l]),
                    	name: l,
                    	type: 'scatter'
                	}
                	case 'rotate':
                	return {
                    	//x: data.telemetry.map(x =>  Date.parse(x.datetime)),
                   		x: data.telemetry.map(x =>  x.datetime),
                    	y: data.telemetry.map(x => x[l]),
                    	name: l,
                    	yaxis: 'y2',
                    	type: 'scatter'
                	}
                	case 'vibration':
                	return {
                    	//x: data.telemetry.map(x =>  Date.parse(x.datetime)),
                   		x: data.telemetry.map(x =>  x.datetime),
                    	y: data.telemetry.map(x => x[l]),
                    	name: l,
                    	yaxis: 'y2',
                    	visible: 'legendonly',
                    	type: 'scatter'
                	}
                }
            });

            function verticalLines(l, yname, name, color) {
                var zero  = 1;
                var trace = {
                    x: [],
                    y: [],
                    name: name,
                    type:'scatter',
                    mode: 'lines+markers',
                    line: {color: color, width: 2},
                    marker: {color: color, width: 1}
                };

                for(i=0; i < l.length; i ++) {
                    //var seconds = Date.parse(l[i].datetime)
                    var seconds = l[i].datetime
                    trace.x.push(seconds, seconds, seconds)
                    trace.y.push(zero, 700, zero)

                }

                return trace;
            }

            traces.push(verticalLines(data.failures, 'failure', 'failures',  'rgb(255, 90, 255)'))
            traces.push(verticalLines(data.errors, 'error', 'errors',  'rgb(160, 160, 160)'))

            console.log(traces);
            
            var mylayout = {
            	title:'Telemetry',
  				yaxis: {
    				title: 'pascal',
    				domain: [0, 300],
    				titlefont: {color: 'rgb(255,158,85)'},
    				tickfont: {color: 'rgb(255,158,85)'},
  				},
  				yaxis2: {
    				title: 'Hertz',
    				domain: [0, 800],
    				titlefont: {color: 'rgb(44,160,44)'},
    				tickfont: {color: 'rgb(44,160,44)'},
    				overlaying: 'y',
    				side: 'right'
  				},
  				height: 1500,
            }
            
            Plotly.newPlot(widget.get(0), traces, mylayout);
        }
    });

}
</script>



{% endblock %}
